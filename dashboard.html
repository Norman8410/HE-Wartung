<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>BOSCH - Global Wartung Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --bosch-red: #d50000; --bosch-dark-red: #8b0000; --bosch-blue: #003a6c; --bosch-green: #008a4f; --bosch-gray: #eff1f2; --bosch-orange: #ffa500; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bosch-gray); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .top-bar { height: 45px; background: linear-gradient(90deg, #d50000 0%, #d50000 25%, #003a6c 25%, #003a6c 50%, #00b5e2 50%, #00b5e2 75%, #008a4f 75%, #008a4f 100%); display: flex; align-items: center; padding: 0 15px; color: white; font-weight: bold; }
        .header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .bosch-text { color: #d50000; font-size: 22px; font-weight: 900; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; padding: 15px; flex: 1; overflow: hidden; }
        .col { background: #fdfdfd; border-radius: 4px; display: flex; flex-direction: column; border-top: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .col-header { padding: 10px; font-weight: bold; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .col-content { padding: 10px; overflow-y: auto; flex: 1; }
        .card { background: white; border: 1px solid #ddd; padding: 10px; margin-bottom: 8px; border-left: 8px solid #ccc; position: relative; }
        .card-type { font-size: 9px; font-weight: bold; color: #777; margin-bottom: 3px; }
        .card-id { font-size: 16px; font-weight: bold; color: var(--bosch-blue); }
        .card-rest { font-size: 14px; font-weight: bold; float: right; }
        .crit { border-left-color: var(--bosch-dark-red); background: #fff5f5; }
        .urg { border-left-color: var(--bosch-red); }
        .warn { border-left-color: var(--bosch-orange); }
        .nav-a { text-decoration: none; color: var(--bosch-blue); font-size: 12px; font-weight: bold; margin-left: 15px; }
    </style>
</head>
<body>
    <div class="top-bar">Globales Wartungs-Cockpit</div>
    <div class="header">
        <div><span class="bosch-text">BOSCH</span> <small>Wartung √úbersicht</small></div>
        <div>
            <a class="nav-a" href="index.html">‚öôÔ∏è HE</a>
            <a class="nav-a" href="https://norman8410.github.io/unotron-wartung/">üß™ Unotron</a>
            <a class="nav-a" href="https://norman8410.github.io/agie-wartung/">‚ö° Agie</a>
        </div>
    </div>
    <div class="grid">
        <div class="col" style="border-top-color: var(--bosch-dark-red)">
            <div class="col-header" style="color: var(--bosch-dark-red)">√úberf√§llig <span id="c1">0</span></div>
            <div id="l1" class="col-content"></div>
        </div>
        <div class="col" style="border-top-color: var(--bosch-red)">
            <div class="col-header" style="color: var(--bosch-red)">Kritisch (< 3%) <span id="c2">0</span></div>
            <div id="l2" class="col-content"></div>
        </div>
        <div class="col" style="border-top-color: var(--bosch-orange)">
            <div class="col-header" style="color: var(--bosch-orange)">Warnung (< 12%) <span id="c3">0</span></div>
            <div id="l3" class="col-content"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD6xGCtU-felOyO_BRsFnVlB4yhC46FgYg",
            authDomain: "bosch-agie-wartung.firebaseapp.com",
            databaseURL: "https://bosch-agie-wartung-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "bosch-agie-wartung",
            storageBucket: "bosch-agie-wartung.firebasestorage.app",
            messagingSenderId: "211606405555",
            appId: "1:211606405555:web:cc2475ca47804086a3cbc6"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const HE_INT = 156000, AGIE_INT = 156000;
        const UNO_STEPS = [2000, 4000, 10000, 14000, 18000, 26000, 28000, 30000, 34000, 42000, 50000, 56000, 58000, 66000, 74000, 82000, 90000, 98000, 104000];

        function loadAll() {
            let list = [];
            
            // Unotron
            db.ref('maintenanceStateUnotron').once('value', s => {
                const d = s.val() || {};
                (d.cloudRawData || []).forEach(m => {
                    const id = m.STATIONNO, ist = parseInt(m['COUNT(*)']) || 0, c = (d.extraCycles || {})[id] || 0;
                    const prev = c > 0 ? UNO_STEPS[c-1] : 0, target = UNO_STEPS[c] || 104000;
                    addToList(list, 'üß™ Unotron', id, target - ist, ((target-ist)/(target-prev))*100);
                });
                
                // HE
                db.ref('maintenanceStateHE').once('value', s => {
                    const d = s.val() || {};
                    (d.cloudRawData || []).forEach(m => {
                        const id = m.StationNo, ist = (parseInt(m.Parts) || 0) + ((d.manualOffsets || {})[id] || 0), c = (d.extraCycles || {})[id] || 0;
                        const target = (c + 1) * HE_INT;
                        addToList(list, '‚öôÔ∏è HE', id, target - ist, ((target - ist) / HE_INT) * 100);
                    });

                    // Agie
                    db.ref('maintenanceState').once('value', s => {
                        const d = s.val() || {};
                        (d.cloudRawData || []).forEach(m => {
                            const id = m.StationNo, ist = (parseInt(m.Parts) || 0) + ((d.manualOffsets || {})[id] || 0), c = (d.extraCycles || {})[id] || 0;
                            const target = (c + 1) * AGIE_INT;
                            addToList(list, '‚ö° Agie', id, target - ist, ((target - ist) / AGIE_INT) * 100);
                        });
                        render(list);
                    });
                });
            });
        }

        function addToList(list, type, id, rest, perc) {
            let status = '';
            if (rest <= 0) status = 'crit';
            else if (perc <= 3.125) status = 'urg';
            else if (perc <= 12.5) status = 'warn';
            if (status) list.push({ type, id, rest, status });
        }

        function render(list) {
            let html = { crit: '', urg: '', warn: '' }, count = { crit: 0, urg: 0, warn: 0 };
            list.sort((a,b) => a.rest - b.rest).forEach(m => {
                count[m.status]++;
                html[m.status] += `<div class="card ${m.status}"><div class="card-rest">${m.rest.toLocaleString()}</div><div class="card-type">${m.type}</div><div class="card-id">${m.id}</div></div>`;
            });
            for(let key in html) {
                document.getElementById('l' + (key=='crit'?'1':key=='urg'?'2':'3')).innerHTML = html[key];
                document.getElementById('c' + (key=='crit'?'1':key=='urg'?'2':'3')).innerText = count[key];
            }
        }
        loadAll();
        setInterval(loadAll, 60000);
    </script>
</body>
</html>
